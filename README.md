# Агент DataAnalyst (локально)

Этот проект реализует описанный в `AGENTS.md` локальный агент аналитики данных. Он читает “сырые” файлы из `_in/`, делает их чистыми и воспроизводимыми, считает месячную выручку по регионам, строит графики и сохраняет всё это в `_out/`.

## Как работает агент

1. **Контекст и план**  
   Агент всегда действует как data analyst/engineer: перед запуском описывает план обработки (какие файлы и какие артефакты появятся), а переходы между этапами сопровождаются логами и рекомендациями.

2. **Сбор и инспекция данных**  
   Перебирает файлы в `_in/`, определяет формат (`.csv`, `.xlsx`, `.parquet` и т.д.) и выгружает первые строки и метаданные (названия колонок, типы, примерные значения). Это помогает сопоставить столбцы.

3. **Нормализация схемы**  
   Все имена колонок приводятся к понятному стилю (snake_case, латиница). Дата приводится к `datetime`, числовые поля — к `float`/`decimal`. Пропуски обрабатываются по описанным правилам, дубликаты удаляются, явно неправильные строки (отрицательная выручка, дата вне диапазона и т.д.) фильтруются.

4. **Агрегация**  
   На основе эвристики агент определяет колонки «дата», «регион», «выручка». Добавляет колонку `year_month = date.dt.to_period("M").astype(str)` и группирует по `(region, year_month)`, считая суммарную выручку. Результат сохраняется в `_out/aggregates/revenue_by_region_month.csv`.

5. **Визуализации**  
   Строит графики:
   - общий график динамики дохода по регионам (линия с легендой или stacked bar);
   - отдельные графики по каждому региону.  
   Все изображения сохраняются в `_out/viz/` под именами `revenue_by_region_month_overall.png` и `revenue_by_region_month_<REGION>.png`.

6. **Отчёт**  
   Алиас создаёт краткий Markdown-отчёт `_out/aggregates/REPORT.md` с описанием источников, шагов очистки и выводов (топ-3 региона, значимые всплески/провалы).

7. **Повторяемость и качества**  
   Все ключевые операции оформлены в функциях с понятными именами (`load_raw_data`, `normalize_columns` и т.д.), параметры вынесены в начало скриптов, каждый этап логируется. В случае ошибок при загрузке/парсинге дат агент сообщает о проблеме и предлагает, как её исправить.

## Структура выходных файлов

- `_out/clean/` — очищенные версии исходных файлов.  
- `_out/aggregates/revenue_by_region_month.csv` — агрегат по месяцам и регионам.  
- `_out/viz/` — графики `.png`.  
- `_out/aggregates/REPORT.md` — текстовый отчёт.

Если папки отсутствуют, агент создаёт их автоматически.

## Что делать для запуска

1. Поместите файлы с данными в `_in/`. Названия столбцов могут отличаться, агент пытается сопоставить их автоматически, но при сомнениях запросит уточнение у пользователя.  
2. Воспользуйтесь `scripts/analyze_revenue.py` (или аналогичным файлом) для последовательного выполнения всех шагов: загрузка, очистка, агрегация, визуализация.  
3. Убедитесь, что после запуска появились файлы в `_out/clean/`, `_out/aggregates/` и `_out/viz/`.  
4. Откройте `_out/aggregates/REPORT.md`, чтобы получить краткий итог работы и главные выводы.

## Рекомендации по поддержке

- При добавлении новых датасетов пунктируйте их структуру — это ускорит эвристику сопоставления колонок.  
- Добавляйте новые проверки качества в `clean_dataframe`, чтобы ловить специфичные признаки плохих данных (например, валюту, неизвестные регионы и т.д.).  
- Расширяйте отчёт осмысленной аналитикой (сравнение регионов, сезонность), если появляются дополнительные метрики.
